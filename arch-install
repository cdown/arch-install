#!/bin/bash -e

# curl -Lo setup https://bit.ly/1amkr3b

read -rp "Hostname: " hostname
read -rp "Device: " device
read -rp "Timezone: " timezone

# Avoid reaching max label length for ext*
short_hostname=${hostname::5}

fdisk "$device" << 'EOF'
o
n
p
1

+1024M
t
82
n
p
2

+512M
n
p
3


a
3
w
EOF

mountpoint=$(mktemp -d)

swap_partition=${device}1
boot_partition=${device}2
encrypted_root_partition=${device}3
root_device=cryptroot
root_device_path=/dev/mapper/$root_device
swap_device=cryptswap
swap_device_path=/dev/mapper/$swap_device

mkfs.ext4 -L "$short_hostname"-/boot "$boot_partition"
cryptsetup -y -v luksFormat "$encrypted_root_partition"

cryptsetup open "$encrypted_root_partition" "$root_device"
mkfs.ext4 -L "$short_hostname"-/ "$root_device_path"

mount "$root_device_path" "$mountpoint"
mkdir -p "$mountpoint"/boot
mount "$boot_partition" "$mountpoint"/boot

pacman -Syy
pacman --noconfirm --ignore pacman -S reflector

reflector \
    -c 'United Kingdom' -c France -c Germany -c Sweden -c Finland -c Denmark \
    -c Ireland -c Netherlands \
    -f 6 --protocol http --sort rate --save /etc/pacman.d/mirrorlist

pacstrap "$mountpoint" base base-devel syslinux

sed -i '/^HOOKS=/s/filesystems/encrypt &/' "$mountpoint"/etc/mkinitcpio.conf
arch-chroot "$mountpoint" mkinitcpio -p linux

cp /etc/pacman.d/mirrorlist "$mountpoint"/etc/pacman.d/mirrorlist

# Any one will do, so we just get the first
swap_by_id=$(find -L /dev/disk/by-id -samefile "$swap_partition" | head -1)

cat > "$mountpoint"/etc/crypttab << EOF
$swap_device $swap_by_id /dev/urandom swap,cipher=aes-cbc-essiv:sha256,size=256
EOF

cat > "$mountpoint"/etc/fstab << EOF
LABEL=$short_hostname-/boot /boot ext4 defaults 0 1
LABEL=$short_hostname-/     /     ext4 defaults 0 1
$swap_device_path           none  swap sw       -1 0
EOF

echo 'LANG="en_GB.UTF-8"' > "$mountpoint"/etc/locale.conf
cat > "$mountpoint"/etc/locale.gen << 'EOF'
en_GB.UTF-8 UTF-8
en_US.UTF-8 UTF-8
EOF
echo "$hostname" > "$mountpoint"/etc/hostname

arch-chroot "$mountpoint" syslinux-install_update -i -a -m

encrypted_root_uuid=$(cryptsetup luksUUID "$encrypted_root_partition")

cat > "$mountpoint"/boot/syslinux/syslinux.cfg << EOF
PROMPT 0
TIMEOUT 0
DEFAULT arch

LABEL arch
    LINUX ../vmlinuz-linux
    APPEND cryptdevice=UUID=$encrypted_root_uuid:$root_device root=$root_device_path rw
    INITRD ../initramfs-linux.img

LABEL archfallback
    LINUX ../vmlinuz-linux
    APPEND cryptdevice=UUID=$encrypted_root_uuid:$root_device root=$root_device_path rw
    INITRD ../initramfs-linux-fallback.img
EOF

arch-chroot "$mountpoint" ln -sf /usr/share/zoneinfo/"$timezone" /etc/localtime
arch-chroot "$mountpoint" locale-gen

while ! arch-chroot "$mountpoint" passwd; do :; done
